<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RevBayes Total Evidence Tree Estimation • Phylogenetic Paleobiology at GSA 2019</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="RevBayes Total Evidence Tree Estimation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">Phylogenetic Paleobiology at GSA 2019</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">9.21.2019</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a></a>
</li>
<li>
  <a></a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../../articles/organizers.html">Our Team</a>
</li>
<li>
  <a href="../../articles/code_conduct.html">Expected Conduct</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Software &amp; Materials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/install_main.html">Required Software to Install</a>
    </li>
    <li>
      <a href="../../articles/downloads.html">Required Materials to Download</a>
    </li>
    <li>
      <a href="../../articles/readings.html">Recommended Readings</a>
    </li>
    <li>
      <a href="../../articles/install_extra.html">Extra Software</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Schedule &amp; Lessons
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/schedule.html">Workshop Schedule</a>
    </li>
    <li>
      <a href="../../articles/module_02_meet_our_dataset_S&amp;Z2009/module_02.html">2 - Meet Our Dataset</a>
    </li>
    <li>
      <a href="../../articles/module_03_coding_from_scratch/module_3.html">3 - Coding Characters From Scratch</a>
    </li>
    <li>
      <a href="../../articles/module_04_Intro_RevBayes_Graphical_Modeling/module_04.html">4 - RevBayes &amp; Graphical Models</a>
    </li>
    <li>
      <a href="../../articles/module_05_tutorial_structure/index.html">5 - RevBayes - Setup</a>
    </li>
    <li>
      <a href="../../articles/module_06_TripartiteModel1_morph_change_models/RB_MCMC_Discrete_Morph.html">6 - Tripartite Model I - Discrete Morphology - Models and Tree Inference</a>
    </li>
    <li>
      <a href="../../articles/module_07_TripartiteModel2_clock_models/Clock_models_for_character_data.html">7 - Tripartite Model II - Clock Models of Character Change</a>
    </li>
    <li>
      <a href="../../articles/module_08_TripartiteModel3_Fossilized_Birth_death/RB_Total_Evidence_Tutorial.html">8 - Tripartite Model III - Fossilized Birth Death Model</a>
    </li>
    <li>
      <a href="../../articles/module_09_worked_PCM_example/module_08.html">9 - Phylogenetic Comparative Methods</a>
    </li>
    <li>
      <a href="../../articles/symbols.html">Notation Guide</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/dwbapst/PaleoSoc_phylo_short_course_2019">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>RevBayes Total Evidence Tree Estimation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dwbapst/PaleoSoc_phylo_short_course_2019/blob/master/vignettes/module_08_TripartiteModel3_Fossilized_Birth_death/RB_Total_Evidence_Tutorial.Rmd"><code>vignettes/module_08_TripartiteModel3_Fossilized_Birth_death/RB_Total_Evidence_Tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>RB_Total_Evidence_Tutorial.Rmd</code></div>

    </div>

    
    
<p>This tutorial builds upon the previous three tutorials to estimate a dated phylogeny from discrete morphological data using the Fossilized Birth-Death Model (FBD) <span class="citation">(<span class="citeproc-not-found" data-reference-id="stadler2010"><strong>???</strong></span>; <span class="citeproc-not-found" data-reference-id="heath2014"><strong>???</strong></span>)</span>. Broadly, the FBD model is a “total-evidence” model and can incorporate fossil ages, molecular data, and morphological data to estimate a tree with branch lengths in units of absolute time. In this tutorial, we will focus on fossil ages and morphological data to estimate our phylogeny. Using an example from a 2013 by Zamora et al., we will estimate a total evidence phylogeny of the Cinctans.</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><img src="figures/TotalEvidence.png"><em>Figure One: A representation of the data required for and model subcomponents of the Fossilized Birth-Death model</em></p>
<p>The above figure (Warnock and Wright 2020) demonstrates the “total-evidence” framework of the FBD model. In this model, there are three submodels. One describes cahracter change (the substitution model), one describes how rates of evolution are distributed across the tree (the clock model), and the final component describes how speciation, extinction and fossil sampling events are distributed in time (the tree model). The substitution and clock models have been discussed in the previous two tutorials.</p>
<p>Below is an image from Warnock and Wright (2020) showing the true tree and the reconstructed tree. The reconstructed tree is the tree we are capable of inferring from our fossil phylogenetic characters and our fossil ages. The true tree, on the other hand, is unkowable, as we will never have complete sampling in the past and the present.</p>
<p><img src="figures/figure5.png"><em>Figure Two: Different sets of FBD parameters can give rise to different reconstructed trees</em></p>
<div id="tree-model" class="section level2">
<h2 class="hasAnchor">
<a href="#tree-model" class="anchor"></a>Tree model</h2>
<p>In this tutorial, we will explain a prior on topologies, divergence times, and macroevolutionary parameters called the <em>fossilized birth-death</em> (FBD) process <span class="citation">(Stadler 2010; Heath, Huelsenbeck, and Stadler 2014)</span>. This manner of divergence time estimation is different than other approaches. For example, you may be familiar with <em>node calibration</em> approaches, in which the age of a fossil is used to constrain the age of a node. While these approaches have historically been well-used, the FBD makes more complete use of the fossil record. This is because the FBD, as shown on figure 1, is a hierarchical prior. This allows us to model the evolution of morphological characters to place specimens on the tree. Rather than using only the age information, and telling the method where the fossil goes, the placement of the fossil can be estimated in the analysis. Taxa without phylogenetic characters can still be used in this analysis. While they cannot be placed using a character model, the FBD model marginalizes over possible placements for a taxon, which allows for the age information to still be used.</p>
<p>The FBD model is a macroevolutionary model describing the process of speciation ( the addition of lineages to the tree - $ $), extinction (the removal of lineages from a population - $ $), fossil sampling (recovery of lineages in the past - $ $) and extant sampling (recovery of contemporaneous lineages - $ <span class="math inline">\(). Origin time (\)</span> $) describes the time at which the process of diversification and sampling began in your lineage.</p>
<p><img src="figures/tikz/fbd_gm-eps-converted-to.png"><em>Figure Three: A graphical model showing the FBD from a <a href="https://revbayes.github.io/tutorials/fbd/">tutorial</a> by Heath, Wright and Pett can be seen below.</em></p>
<p>As shown in Fig. 2, different combinations of these parameters can lead to different shapes of the reconstructed tree. In all of these simulations, the lineage begins with one lineage at 40 million years ago. As can be seen on the figure, different sets of parameters can lead to more samples in the past, or fewer. Parameters such as extinction and speciation can lead to different number of nodes on the tree. And fossil sampling generates the possibility that some sampled fossils actually lie as 2-degree nodes. That is, they did not go extinct when sampled, and have descendents on the phylogeny.</p>
</div>
</div>
<div id="example-estimating-the-phylogeny-and-divergence-times-of-fossil-cinctans" class="section level1">
<h1 class="hasAnchor">
<a href="#example-estimating-the-phylogeny-and-divergence-times-of-fossil-cinctans" class="anchor"></a>Example: Estimating the Phylogeny and Divergence Times of Fossil Cinctans</h1>
<p>In this exercise, we will combine different types of data from 23 fossil species. For the fossil species, occurrence times are obtained from the literature or fossil databases like the <a href="http://fossilworks.org/">Fossilworks PaleoDB</a> or the <a href="http://fossilcalibrations.org/">Fossil Calibration Database</a>, or from your own paleontological expertise. |</p>
<div id="load-taxon-list" class="section level3">
<h3 class="hasAnchor">
<a href="#load-taxon-list" class="anchor"></a>Load Taxon List</h3>
<p>First, we will load in a list of all the taxa that will be in our analysis. This includes taxa for which we have morphological data, and taxa for which we only have ages. We will load the <code>cinctans_taxa.tsv</code> file using the <code>readTaxonData()</code> function.</p>
<pre class="revbayes"><code>    taxa &lt;- readTaxonData("data/cincta_fossil_intervals_FA.tsv")</code></pre>
<p>This function reads a tab-delimited file and creates a variable called <code>taxa</code> that is a list of all of the taxon names relevant to this analysis. This list includes all of cinctans we are adding to the tree. Because fossils are data under the FBD model, even in the absence of phylogenetic characters, they are included in the file.</p>
</div>
<div id="load-data-matrices" class="section level3">
<h3 class="hasAnchor">
<a href="#load-data-matrices" class="anchor"></a>Load Data Matrices</h3>
<p><code>RevBayes</code> uses the function <code>readDiscreteCharacterData()</code> to load a data matrix to the workspace from a Nexus formatted file. This function can be used for both discrete morphological characters and molecular characters, if you have them.</p>
<p>Import the morphological character matrix and assign it to the variable <code>morpho</code>.</p>
<pre class="revbayes"><code>    morpho &lt;- readDiscreteCharacterData("data/Cinctans.nex")</code></pre>
<pre><code>## Successfully read one character matrix from file 'data/Cinctans.nex'</code></pre>
</div>
<div id="create-helper-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#create-helper-variables" class="anchor"></a>Create Helper Variables</h3>
<p>Before we begin writing the <code>Rev</code> scripts for each of the model components, we need to instantiate a couple “helper variables” that will be used by downstream parts of running and using our models. These variables will be used in multiple places in the analysis, and so we will instantiate them before going any further.</p>
<p>Create a new constant node called <code>n_taxa</code> that is equal to the number of species in our analysis (22).</p>
<pre class="revbayes"><code>    n_taxa &lt;- taxa.size() 
    num_branches &lt;- 2 * n_taxa - 2</code></pre>
<p>Next, create a workspace variable called <code>moves</code>. This variable is an iterator that will build a vector containing all of the MCMC moves used to propose new states for every stochastic node in the model graph. Each time we add a parameter to the model, and put a prior on it, this will be incremented by <code>1</code>.</p>
<pre class="revbayes"><code>    moves = VectorMoves()
    monitors = VectorMonitors()</code></pre>
<p>Moves and monitors are part of the RevBayes workspace. They are not parameters of the model. They specify how values for parameters will be sampled. Because they are in the workspace, they are specified with the <code>=</code> operator, rather than the assignment operator <code>&lt;-</code>.</p>
</div>
<div id="the-fossilized-birth-death-process" class="section level2">
<h2 class="hasAnchor">
<a href="#the-fossilized-birth-death-process" class="anchor"></a>The Fossilized Birth-Death Process</h2>
<div id="speciation-and-extinction-rates" class="section level3">
<h3 class="hasAnchor">
<a href="#speciation-and-extinction-rates" class="anchor"></a>Speciation and Extinction Rates</h3>
<p>We will begin by specifying the speciation and extinction rates. These parameters govern the rate at which lineages are added to and removed from the population. From a previous study we know that an expoential distribution with a parameter of 1.471 is a reasonable distribution in which this value could lie.</p>
<pre class="revbayes"><code>  speciation_rate ~ dnExponential(1.471)

  moves.append(mvScale(speciation_rate, lambda=0.01, weight=5));
  moves.append(mvScale(speciation_rate, lambda=0.10, weight=3));
  moves.append(mvScale(speciation_rate, lambda=1.00, weight=1));</code></pre>
<p>It is possible to set extinction as its own parameter, for example, like so:</p>
<pre class="revbayes"><code>  extinction_rate ~ dnExponential(10)</code></pre>
<p>However, extinction and speciation rates are often correlated. And so we will instantiate a parameter called turnover, which is the ratio of extinction rate to speciation rate ($ $ / $ $). The parameters to this lognormal distribution were arrived at by simulation of parameter values from the data.</p>
<pre class="revbayes"><code>    turnover ~ dnLognormal(0.945, 1.926745);
    moves.append(mvSlide(turnover, delta=0.01, weight=5))
    moves.append(mvSlide(turnover, delta=0.10, weight=3))
    moves.append(mvSlide(turnover, delta=1.00, weight=1))</code></pre>
<p>As discussed in previous lessons, moves specify how often (<em>weight</em>), we will sample new values for the parameters in our model. The <em>delta</em> of the slide move specifies how different from the initial value a propsed new parameter will be. More information on moves can be found in the <a href="https://revbayes.github.io/tutorials/mcmc/binomial.html">MCMC tutorial</a>.</p>
<p>Once our turnover is defined, we can also monitor our extinction values like so:</p>
<pre class="revbayes"><code>    extinction_rate := turnover*speciation_rate
    diversification := speciation_rate - extinction_rate</code></pre>
<p>Next, we will define the sampling in the present. Cinctans are extinct. We will rescale our times such that the last appearance of Cinctans in the fossil record is the ‘present’. Previous studies indicate that about half of Cinctans that existed them are in this analysis <span class="citation">(Zamora, Rahman, and Smith 2013)</span>. We will treat $ $ as a known quantity, a constant node. We will therefore, not specify any moves on this parameter.</p>
<pre class="revbayes"><code>    rho &lt;- .506</code></pre>
<p>Our data is made up of fossils. We also need to define the rate at which fossils are recovered on the tree. This is the fossil sampling rate (<span class="math inline">\(\psi\)</span> in Fig. 3). This is also referred to in the literature as the <code>recovery</code> rate. Prior research indicates that an exponential distribution with parameter 3.892 should be adequate.</p>
<pre class="revbayes"><code>    psi ~ dnExponential(3.892) 
    moves.append(mvScale(psi, lambda=0.01, weight=1))
    moves.append(mvScale(psi, lambda=0.1,  weight=1))
    moves.append(mvScale(psi, lambda=1,    weight=1))</code></pre>
<p>If you do not have a good intution for what this distribution looks like, you can visualize it below.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">draws &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="dv">1000</span>, <span class="fl">3.891</span>)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(draws)</a></code></pre></div>
<p><img src="RB_Total_Evidence_Tutorial_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div id="the-origin-time" class="section level3">
<h3 class="hasAnchor">
<a href="#the-origin-time" class="anchor"></a>The Origin Time</h3>
<p>Finally, we need to define an origin time for the Cinctan group. Because we are rescaling the analysis to the treat the ‘present’ as last observation of Cinctans, our origin time will be drawn from a uniform distribution between 10.2 and 15.2 mya. In actuality, this corresponds to 508 to 513 million years ago.</p>
<pre class="revbayes"><code>
    origin_time ~ dnUnif(10.2, 15.2);
    moves.append(mvSlide(origin_time, delta=0.01, weight=5.0))
    moves.append(mvSlide(origin_time, delta=0.1,  weight=5.0))
    moves.append(mvSlide(origin_time, delta=1,    weight=5.0))</code></pre>
</div>
<div id="the-fbd-distribution-object" class="section level3">
<h3 class="hasAnchor">
<a href="#the-fbd-distribution-object" class="anchor"></a>The FBD Distribution Object</h3>
<p>All the parameters of the FBD process have now been specified. The next step is to use these parameters to define the FBD tree prior distribution, which we will call <code>fbd_dist</code>. We will use this distribution to simulate a starting tree.</p>
<pre class="revbayes"><code>
    fbd_dist = dnFBDP(origin=origin_time, lambda=speciation_rate, mu=extinction_rate, psi=psi, rho=rho, taxa=taxa)</code></pre>
<p>There has been a good amount of prior work on Cinctans, and we are able to define the ingroup for the Cinctans. For our taxa without phylogenetic characters, this allows us to tell the model that those taxa belong inside the ingroup. The model can then marginalize over their exact placement, and use the age information to date the total ingroup.</p>
<pre class="revbayes"><code>
ingroup = clade("Ctenocystis_utahensis","Gyrocystis_platessa","Gyrocystis_testudiformis","Gyrocystis_cruzae","Gyrocystis_badulesiensis", "Gyrocystis_erecta","Progyrocystis_disjuncta","Protocinctus_mansillaensis","Elliptocinctus_barrandei","Elliptocinctus_vizcainoi","Sucocystis_theronensis","Sucocystis_bretoni","Lignanicystis_barriosensis","Undatacinctus_undata","Sucocystis_acrofera","Undatacinctus_quadricornuta","Undatacinctus_melendezi","Sotocinctus_ubaghsi","Ludwigicinctus_truncatus","Graciacystis_ambigua","Nelegerocystis_ivantzovi","Rozanovicystis_triangularis","Davidocinctus_pembrokensis")
constraints = v(ingroup)</code></pre>
<p>Next, we will draw a starting tree out of this distribution. This will be a tree that is feasible given our model parameters, and consistent with our clade constraints.</p>
<pre class="revbayes"><code>    fbd_tree ~ dnConstrainedTopology(fbd_dist, constraints=constraints)</code></pre>
</div>
<div id="moves-on-the-tree-topology-and-node-ages" class="section level3">
<h3 class="hasAnchor">
<a href="#moves-on-the-tree-topology-and-node-ages" class="anchor"></a>Moves on the Tree Topology and Node Ages</h3>
<p>Fossils require some special moves we have not yet seen in any of the tutorials. Firstly, there is <code>mvFNPR</code>, which makes changes to the tree with the knowledge that some tips may not be contemporaneous. <code>mvCollapseExpandFossilBranch</code> allows fossils to transiton between being sampled ancestors and tips. The <code>TimeSlide</code> moves allow us to sample values for node and origin ages.</p>
<pre class="revbayes"><code>    moves.append(mvFNPR(fbd_tree, weight=15.0))
    moves.append(mvCollapseExpandFossilBranch(fbd_tree, origin_time, weight=6.0))
    moves.append(mvNodeTimeSlideUniform(fbd_tree, weight=40.0))
    moves.append(mvRootTimeSlideUniform(fbd_tree, origin_time, weight=5.0))</code></pre>
</div>
<div id="sampling-fossil-occurrence-ages" class="section level3">
<h3 class="hasAnchor">
<a href="#sampling-fossil-occurrence-ages" class="anchor"></a>Sampling Fossil Occurrence Ages</h3>
<p>Next, we need to account for uncertainty in the age estimates of our fossils using the observed minimum and maximum stratigraphic ages provided in the file <code>cinctans_fossil_intervals.tsv</code>. These values are were obtained and cleaned from the Paleobiology Database. First, we read this file into a matrix called <code>intervals</code>.</p>
<pre class="revbayes"><code>    intervals = readDataDelimitedFile(file="data/cincta_fossil_intervals_FA.tsv", header=true)</code></pre>
<p>Next, we loop over this matrix. For each fossil observation, we create a uniform random variable representing the likelihood. In this equation <span class="math inline">\(t_i\)</span> is the fossil age. <span class="math inline">\(a_i\)</span> and <span class="math inline">\(b_i\)</span> are the minimum and maximum edges of the fossil age range. And so, we treat the fossil age as being drawn from a uniform distribution between <span class="math inline">\((t_i - b_i)\)</span> and <span class="math inline">\((t_i - a_i)\)</span></p>
<pre class="revbayes"><code>
  intervals = readDataDelimitedFile(file="data/cincta_fossil_intervals_FA.tsv", header=true)
  for(i in 1:intervals.size())
  {
      taxon  = intervals[i][1]
      a_i = intervals[i][2]
      b_i = intervals[i][3]
      t[i] := tmrca(fbd_tree, clade(taxon))
  
      fossil[i] &lt;- a_i
      fossil[i] ~ dnSoftBoundUniformNormal(t[i] - b_i, t[i] - a_i, sd = 2, p = 0.025)
  }</code></pre>
<p>Finally, we add a move that samples the ages of the fossil nodes on the tree.</p>
<pre class="revbayes"><code>  moves.append(mvFossilTimeSlideUniform(fbd_tree, origin_time, weight=5.0))</code></pre>
<p>We are also going to write the number of sampled ancestors in our analysis to our log files. You may be interested in this value.</p>
<pre class="revbayes"><code>    num_samp_anc := fbd_tree.numSampledAncestors()</code></pre>
</div>
</div>
</div>
<div id="clock-model" class="section level1">
<h1 class="hasAnchor">
<a href="#clock-model" class="anchor"></a>Clock model</h1>
<p>We will use the clock model we specified in the <a href="https://dwbapst.github.io/PaleoSoc_phylo_short_course_2019/articles/module_07_TripartiteModel2_clock_models/Clock_models_for_character_data.html">previous section</a> again.</p>
<pre class="revbayes"><code>
    ucln_mean ~ dnExponential(2.0)
    # sigma
    ucln_sigma ~ dnExponential(3.0) 
    # Set a deterministic node on sigma^2 
    ucln_var := ucln_sigma * ucln_sigma 
    ucln_mu := ln(ucln_mean) - (ucln_var * 0.5)
    moves.append(mvScale(ucln_mean, lambda=1.0, tune=true, weight=4.0))
    moves.append(mvScale(ucln_sigma, lambda=0.5, tune=true, weight=4.0))
    
    for (i in 1:num_branches){
    branch_rate_var[i] ~ dnLognormal(ucln_mu, ucln_sigma)
    moves.append(mvScale(branch_rate_var[i], lambda=1, tune=true, weight=2.0))
    }
    moves.append(mvVectorScale(branch_rate_var,lambda=1.0,tune=true,weight=2.0))
    moves.append(mvVectorSingleElementScale(branch_rate_var,lambda=30.0,tune=true,weight=1.0))
</code></pre>
</div>
<div id="morphological-change-model" class="section level1">
<h1 class="hasAnchor">
<a href="#morphological-change-model" class="anchor"></a>Morphological Change Model</h1>
<p>We will also use the morphology model defined in the <a href="https://dwbapst.github.io/PaleoSoc_phylo_short_course_2019/articles/module_06_TripartiteModel1_morph_change_models/RB_MCMC_Discrete_Morph.html">tree inference section</a></p>
<pre class="revbayes"><code>
    alpha_morpho ~ dnUniform( 0, 1E6 )
    rates_morpho := fnDiscretizeGamma( alpha_morpho, alpha_morpho, 4 )
    #Moves on the parameters of the Gamma distribution.
    moves.append(mvScale(alpha_morpho, lambda=1, weight=2.0))

    n_max_states &lt;- 7
    idx = 1
    morpho_bystate[1] &lt;- morpho
    for (i in 2:n_max_states) {
        # make local tmp copy of data
        # only keep character blocks with state space equal to size i
        morpho_bystate[i] &lt;- morpho
        morpho_bystate[i].setNumStatesPartition(i)
        # get number of characters per character size wth i-sized states
        nc = morpho_bystate[i].nchar()
        # for non-empty character blocks
        if (nc &gt; 0) {
            # make i-by-i rate matrix
            q[idx] &lt;- fnJC(i)
    # create model of evolution for the character block
            m_morph[idx] ~ dnPhyloCTMC( tree=fbd_tree,
                                        Q=q[idx],
                                        nSites=nc,
                                        siteRates=rates_morpho,
                                        branchRates = branch_rate_var,
                                        type="Standard")
    
            # attach the data
            m_morph[idx].clamp(morpho_bystate[i])
    
            # increment counter
            idx = idx + 1
            idx
        }
    }</code></pre>
</div>
<div id="running-our-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#running-our-analysis" class="anchor"></a>Running our analysis</h1>
<p>As we have in prior sections, we will now initialize and execute our model. First, we create the model object that contains all of our character change, clock, and tree model parameters and priors.</p>
<pre class="revbayes"><code>    mymodel = model(fbd_tree)</code></pre>
<p>Next, we inform RevBayes where we would like to write our sampled parameters.</p>
<pre class="revbayes"><code>
    monitors.append(mnModel(filename="output/cinc_dated.log", printgen=10))</code></pre>
<p>And where we would like to write our trees.</p>
<pre class="revbayes"><code>
    monitors.append(mnFile(filename="output/cinc_dated.trees", printgen=10, fbd_tree))</code></pre>
<p>We can also echo some facets to the screen</p>
<pre class="revbayes"><code>
    monitors.append(mnScreen(printgen=10, num_samp_anc, origin_time))</code></pre>
<p>And then we initialize the model.</p>
<pre class="revbayes"><code>
     mymcmc = mcmc(mymodel, monitors, moves)</code></pre>
<p>And run it. In a real analysis, you would want to run this for far more than 1000 generations.</p>
<pre class="revbayes"><code>
    mymcmc.run(generations=10000)</code></pre>
<p>And then we quit.</p>
<pre class="revbayes"><code><a href="https://rdrr.io/r/base/quit.html">    q()</a></code></pre>
<div id="evaluate-and-summarize-your-results" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluate-and-summarize-your-results" class="anchor"></a>Evaluate and Summarize Your Results</h2>
<p>Once our analysis is complete, we can analyze the results in various ways. One popular software for assessing convergence in a Bayesian analysis is <a href="https://github.com/beast-dev/tracer/releases/tag/v1.7.1">Tracer</a>. More information on evaluating MCMCs can be found in the <a href="https://revbayes.github.io/tutorials/mcmc/binomial.html">MCMC tutorial</a>.</p>
<p>We can create a variety of summary trees in RevBayes. Common ones include the maximum clade credibility tree, and the consensus tree. The maximum clade credibility tree is the tree that maximuizes the cumulative clade probabilities on that tree. This metric has become popular, as it always yields a tree that is included in the posterior sample. This is in contrast to a strict or semis-strict consensus tree, which includes all clades that have over a specified posterior probability, and may not have been sampled in the analysis. Below, we calculate both.</p>
<pre class="revbayes"><code>trace = readTreeTrace("output/cinc_dated.trees")
mccTree(trace, file = "output/mccTree.tre")
conTree(trace, file = "output/conTree.tre")</code></pre>
<p>The resultant tree files can be viewed in popular tree viewers such as <a href="https://github.com/rambaut/figtree/releases">FigTree</a> or <a href="https://icytree.org/">IcyTree</a>.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Heath2014">
<p>Heath, Tracy A, John P Huelsenbeck, and Tanja Stadler. 2014. “The fossilized birth-death process for coherent calibration of divergence-time estimates.” <em>Proceedings of the National Academy of Sciences</em> 111 (29). National Acad Sciences: E2957–E2966.</p>
</div>
<div id="ref-Stadler2010">
<p>Stadler, T. 2010. “Sampling-through-time in birth-death trees.” <em>Journal of Theoretical Biology</em> 267 (3). Elsevier: 396–404.</p>
</div>
<div id="ref-zamora2013">
<p>Zamora, Samuel, Imran A Rahman, and Andrew B Smith. 2013. “The Ontogeny of Cinctans (Stem-Group Echinodermata) as Revealed by a New Genus, Graciacystis, from the Middle Cambrian of Spain.” <em>Palaeontology</em> 56 (2). Wiley Online Library: 399–410.</p>
</div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#introduction">Introduction</a><ul class="nav nav-pills nav-stacked">
<li><a href="#tree-model">Tree model</a></li>
      </ul>
</li>
      <li>
<a href="#example-estimating-the-phylogeny-and-divergence-times-of-fossil-cinctans">Example: Estimating the Phylogeny and Divergence Times of Fossil Cinctans</a><ul class="nav nav-pills nav-stacked">
<li><a href="#load-taxon-list">Load Taxon List</a></li>
      <li><a href="#load-data-matrices">Load Data Matrices</a></li>
      <li><a href="#create-helper-variables">Create Helper Variables</a></li>
      <li>
<a href="#the-fossilized-birth-death-process">The Fossilized Birth-Death Process</a><ul class="nav nav-pills nav-stacked">
<li><a href="#speciation-and-extinction-rates">Speciation and Extinction Rates</a></li>
      <li><a href="#the-origin-time">The Origin Time</a></li>
      <li><a href="#the-fbd-distribution-object">The FBD Distribution Object</a></li>
      <li><a href="#moves-on-the-tree-topology-and-node-ages">Moves on the Tree Topology and Node Ages</a></li>
      <li><a href="#sampling-fossil-occurrence-ages">Sampling Fossil Occurrence Ages</a></li>
      </ul>
</li>
      </ul>
</li>
      <li><a href="#clock-model">Clock model</a></li>
      <li><a href="#morphological-change-model">Morphological Change Model</a></li>
      <li>
<a href="#running-our-analysis">Running our analysis</a><ul class="nav nav-pills nav-stacked">
<li><a href="#evaluate-and-summarize-your-results">Evaluate and Summarize Your Results</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by David Bapst, April Wright, Sandra Carlson, Laura Soul, David Wright, Rachel Warnock, Peter Wagner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
